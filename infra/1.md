# 다중화
>다중화란 장애가 발생해도 예비 운용장비로 시스템의 기능을 계속할 수 있도록 하는 것을 말한다.

## 다증화의 본질
1. 장애를 산정
- 시스템 장애
    - 라우터 장애로 서비스 정지
    - 서버 장애로 서비스 정지
- 애플리케이션 장애
- 네트워크 구간 장애
    - 애플리케이션 레벨에서 처리

2. 예비 운용 장비 준비
- 똑같은 셋으로 예비 장비 체계 갖추기

3. 운용체제 정비
- 웹 서버 + 라우터를 이중화하여 두는 방식
- Cold Standby
    - 기존의 장비셋에 문제가 생겼을 때 예비 운용장비로 대체하여 사용하는 방식
- Hot Standby
    - 웹 서버에 장애가 발생했을 시를 대비해 예비 운용장비의 전원을 항상 켜두고 유지하는 방식
    - 따라서 즉시 교체 가능

### 장애극복(Failover)
자동적으로 예비 운용장비로 처리를 인계하는 것. 장애 극복을 위해 VIP와 IP주소 인계를 사용함.<br> 
예를 들어, 운용장비에 VIP를 할당해 두고 장애 발생시 예비장비에 VIP를 인계하는 방식.

### 장애검출(HealthCheck)
현재 운용장비에서 장애가 발생하고 있음을 검출하는 방식.

- ICMP 감시(Layer 3)
    - ex. IP
    - echo 요청을 보내서 응답이 돌아오는지 체크
    - 가장 간단한 방식이지만, 웹 서비스가 다운된 경우는 감지할 수 없다.
- 포트 감시(Layer 4)
    - ex. TCP
    - TCP로 접속 테스트하여 접속 여부를 체크
    - 웹 서비스 다운 감지 가능, 과부하 상태로 응답할 수 없다거나 에러를 반환하는 것은 감지하지 못함
- 서비스 감시(Layer 7)
    - ex. WAS
    - HTTP 요청 등을 보내서 정상적인 응답이 돌아오는지 체크
    - 대부분의 이상을 감지 가능하지만 서버의 부하를 유발할 수 있다.

### 웹 서버의 헬스체크
웹 서버를 감시하는 가장 확실한 방법은 HTTP 요청을 통해 응답 유무를 체크하는게 가장 확실. 이보다 더 선제적으로 대응하기 위해 팀에서는 다음과 같은 방식을 사용함.
- 우리팀의 경우 Moni라는 모니터링 도구를 사용함
- 자바에서 `OperatingSystemMXBean`을 이용하여 Load Average, CPU, Active Count Thread 등을 감시하여 기준치를 넘어서면 L4에서 제외하도록 설정

### 라우터의 헬스체크
>ICMP(Internet Control Message Protocol) - 인터넷 제어 메시지 프로토콜, 네트워크 컴퓨터 위에서 돌아가는 운영체제에서 오류 메시지를 전송받는데 주로 쓰임. 인터넷 프로토콜 스위트에 기록된 주요 프로토콜 중 하나.

라우터에 의한 장애를 검출하기 위해 ICMP 감시를 이용할 수 있다. 즉, 여기서 검출하고자 하는 것은 `라우터가 확실히 패킷을 전송할 수 있는가`이다. 웹 서버가 인터넷과 통신할 수 있는 상태 유무를 확인한다.

>웹 서버, 라우터에 한정되지 않고 헬스체크 할 때 [무엇을 확인하고자 하는가]를 명확히 하는 것이 중요하다. 여기서 [무엇을 확인하고자 하는가]는 무엇일까?
- 해당 서버의 이상 유무
- CPU 기준치 오버하는가
- LA 이상 유무
- 메모리 사용량
- 기준치 트래픽

### IP 주소 인계 원리
IP 주소 인계란 단순히 IP 주소를 바꿔서 설정하는 과정만 말하는 것이 아니다. LAN의 세계에서 IP 주소가 아닌 NIC(Network Interface Card)에 고정적으로 할당되어 있는 MAC주소(Media Access Control Address)를 사용해서 통신한다.<br>
다른 서버에 패킷을 보낼 때 MAC주소를 얻기 위한 ARP(Address Resolution Protocol)라는 프로토콜을 이용한다. 한번 얻은 MAC주소는 ARP테이블에서 일정 시간 캐싱한다. 만약, 다른 서버와 통신하고 싶다면 ARP테이블을 갱신해주어야 한다.<br>
갱신 방법은 `gratutious ARP`가 있다. gratutious ARP는 '내 IP주소와 MAC주소는 이것이다'라고 다른 서버에 통지하는 것이다. 

## 웹 서버의 다중화
### DNS 라운드로빈
DNS를 이용해서 하나의 서비스에 여러 대의 서버를 분산시키는 방법이다. DNS서버는 동일한 이름으로 여러 레코드를 등록시키면 질의할 때마다 다른 결과를 반환한다. 문제점은 다음과 같다.
- 서버의 수만큼 글로벌 주소가 필요
- 균등하게 분산되지 않음
- 서버가 다운돼도 감지하지 못함

### DNS 라운드로빈과 로드밸런서의 차이
로드밸런서(부하분산기)는 하나의 IP주소에 대해 요청을 복수의 서버로 분산할 수 있다. 따라서 로드밸런서를 통해 글로벌 주소를 절약할 수 있다.
- 로드밸런서는 서비스용 글로벌 주소를 가진 가상서버로서 동작한다.
- 로드밸런서는 여러 대의 리얼서버 중에 한 대를 선택해서 처리를 중계한다. 반드시, 헬스체크를 성공한 서버를 선택한다.
- 로드밸런서는 고가의 장비라는 이미지가 있다.

### IPVS(리눅스로 로드밸러서 구성)
리눅스는 라우터로서 이용 가능하다. 또한, 방화벽으로서도 충분히 실제 운용 가능한 패킷필터링 기능 등 강력한 네트워크 기능을 내장하고 있다. 특히, IPVS(IP Virtual Server)라는 부하분산 기능을 제공하는 모듈을 포함한다.

#### 로드밸런서의 종류와 IPVS의 기능
로드밸런서는 크게 나눠 L4스위치와 L7스위치 두 종류가 있다.
- L4
    - 트랜스포트 계층까지의 정보를 분석하므로 IP주소나 포트번호에 따라 분산 대상 서버를 지정할 수 있다.
    - **IPVS에 내장되어 있는 기능**
- L7
    - 애플리케이션 계층까지의 정보를 분석마흐로 클라이언트로부터 요청된 URL에 따라 분산대상 서버를 지정할 수 있다.

### 스케줄링 알고리즘
IPVS에서는 몇 가지 스케줄링 알고리즘이 갖춰져 있어서 환경에 맞게 알고리즘을 선택할 수 있다.
- rr(round-robin): 리얼서버를 처음부터 차례로 선택해 간다. 모든 서버로 균등하게 처리가 분산된다.
- wrr(weighted round-robin): rr과 같지만 가중치를 가미해서 분산비율을 변경한다. 가중치가 크면 더 많이 선택.
- lc(least-connection): 접속수가 가장 적은 서버를 선택한다. 대부분 이걸로 충분하다.
- wlc(weighted least-connection): lc와 같지만 가중치를 추가한다. `(접속수+1)/가중치` 이므로 고성능 서버는 가중치를 크게 하는 것이 좋다.
- sed(shortest expected delay): 가장 응답속도가 빠른 서버를 선택한다. 직접 패킷을 날려 측정하는 것이 아닌 active 접속수가 가장 적은 서버를 선택한다. 
- nq(never queue): sed와 동일한 알고리즘이지만 active 접속수가 0인 서버를 최우선으로 선택한다.

이외에도 IPVS를 투과 프록시나 캐시서버 등과 병용해서 성능을 향상시키기 위한 알고리즘들이 있다.
- sh(source hashing): 소스 IP주소로부터 해시값을 계산해서 분산대상 리얼서버를 선택한다.
- dh(destination hashing): 목적지 IP주소로부터 해시값을 계산해서 분산대상 리얼서버를 선택한다.
- lblc(locality-based least-connection): 접속수가 가중치로 지정한 값을 넘기 전까지는 동일한 서버를 선택한다. 모든 서버가 지정한 가중치를 넘기는 경우 마지막에 선택된 서버가 계속 선택된다.
- lblcr(locality-based least-connection with replication): lblc와 거의 같지만 지정한 가중치를 모든 서버가 넘기는 경우 접속수가 가장 적은 서버가 선택된다.

### IPVS 사용하기



# L4장비 동작 방식
L4는 클라이언트에 대한 요청에 대해 VIP에 대한 바인딩 서버리스트를 갖고 있고 IP 헤더의 IP주소 변경 후 리스트의 서버로 패킷을 던져 줌
REAL 서버 응

# L4 vs L7 체크

# 현대의 L7
마이크로서비스 지향형으로 L4의 비용을 줄이고자 Spring Cloud Ribbon과 같은 프레임워크도 나오게 되었다.


# keep alive
